# Story 6.2: 管理界面优化

## Status

Approved

## Story

**As a** 系统管理员,  
**I want** 通过友好的界面管理系统配置和用户,  
**so that** 我可以高效地管理数据源、用户权限、系统配置和监控日志，确保系统的正常运行和安全性。

## Acceptance Criteria

1. 提供数据源管理界面，支持数据源的增删改查和连接测试
2. 实现用户和权限管理界面，支持用户管理、角色分配和权限配置
3. 提供系统配置界面，支持系统参数配置和功能开关管理
4. 实现监控和日志查看界面，支持实时监控、日志查询和告警管理
5. 提供响应式设计，支持桌面端和移动端访问
6. 实现权限控制，确保只有管理员可以访问管理界面
7. 提供数据可视化，支持图表展示和统计分析
8. 实现操作审计，记录所有管理操作日志
9. 提供批量操作功能，支持批量用户管理和权限分配
10. 实现搜索和筛选功能，支持快速定位和查找

## Tasks / Subtasks

- [ ] Task 1: 数据源管理界面 (AC: 1, 6)
  - [ ] 创建数据源列表页面
  - [ ] 实现数据源添加/编辑表单
  - [ ] 添加数据源连接测试功能
  - [ ] 实现数据源状态监控
  - [ ] 创建数据源权限管理

- [ ] Task 2: 用户和权限管理界面 (AC: 2, 9)
  - [ ] 创建用户管理页面
  - [ ] 实现用户添加/编辑/删除功能
  - [ ] 添加角色分配界面
  - [ ] 实现权限配置界面
  - [ ] 创建批量用户操作功能

- [ ] Task 3: 系统配置界面 (AC: 3, 6)
  - [ ] 创建系统参数配置页面
  - [ ] 实现功能开关管理
  - [ ] 添加系统设置表单
  - [ ] 实现配置验证和保存
  - [ ] 创建配置备份和恢复

- [ ] Task 4: 监控和日志界面 (AC: 4, 7)
  - [ ] 创建系统监控仪表板
  - [ ] 实现日志查询和筛选
  - [ ] 添加告警管理界面
  - [ ] 实现性能指标图表
  - [ ] 创建日志导出功能

- [ ] Task 5: 响应式设计和用户体验 (AC: 5, 10)
  - [ ] 实现响应式布局设计
  - [ ] 添加移动端适配
  - [ ] 实现搜索和筛选功能
  - [ ] 创建导航和面包屑
  - [ ] 添加加载状态和错误处理

- [ ] Task 6: 权限控制和安全性 (AC: 6, 8)
  - [ ] 实现管理界面权限控制
  - [ ] 添加操作审计日志
  - [ ] 实现会话管理
  - [ ] 创建安全设置界面
  - [ ] 添加操作确认机制

- [ ] Task 7: 前端组件开发
  - [ ] 创建管理界面布局组件
  - [ ] 实现数据表格组件
  - [ ] 添加表单组件库
  - [ ] 创建图表和仪表板组件
  - [ ] 实现模态框和对话框组件

- [ ] Task 8: 单元测试和集成测试
  - [ ] 编写组件单元测试
  - [ ] 编写页面集成测试
  - [ ] 编写权限控制测试
  - [ ] 编写响应式设计测试
  - [ ] 编写端到端测试

## Dev Notes

### 架构和设计信息

**管理界面架构** [Source: architecture.md#前端架构]

```typescript
interface ManagementInterface {
  // 数据源管理
  dataSourceManagement: {
    list: () => Promise<DataSource[]>;
    create: (config: DataSourceConfig) => Promise<DataSource>;
    update: (id: string, config: DataSourceConfig) => Promise<DataSource>;
    delete: (id: string) => Promise<void>;
    testConnection: (config: DataSourceConfig) => Promise<ConnectionResult>;
  };

  // 用户权限管理
  userManagement: {
    list: () => Promise<User[]>;
    create: (userData: UserData) => Promise<User>;
    update: (id: string, userData: UserData) => Promise<User>;
    delete: (id: string) => Promise<void>;
    assignRole: (userId: string, roleId: string) => Promise<void>;
    assignPermissions: (userId: string, permissions: Permission[]) => Promise<void>;
  };

  // 系统配置
  systemConfig: {
    getConfig: () => Promise<SystemConfig>;
    updateConfig: (config: Partial<SystemConfig>) => Promise<void>;
    getFeatureFlags: () => Promise<FeatureFlags>;
    toggleFeature: (feature: string, enabled: boolean) => Promise<void>;
  };

  // 监控和日志
  monitoring: {
    getSystemMetrics: () => Promise<SystemMetrics>;
    getLogs: (filters: LogFilters) => Promise<LogEntry[]>;
    getAlerts: () => Promise<Alert[]>;
    acknowledgeAlert: (alertId: string) => Promise<void>;
  };
}
```

**权限控制模型** [Source: architecture.md#权限控制]

- 管理界面访问权限：admin, super_admin
- 数据源管理权限：admin, data_admin
- 用户管理权限：admin, user_admin
- 系统配置权限：admin, config_admin
- 监控查看权限：admin, monitor_admin

**响应式设计规范** [Source: architecture.md#前端设计]

- 桌面端：≥1200px
- 平板端：768px - 1199px
- 移动端：<768px
- 断点：xs(0), sm(576), md(768), lg(992), xl(1200), xxl(1400)

### 技术栈

- **前端框架**: React 18 + TypeScript
- **UI组件库**: Ant Design / Material-UI
- **状态管理**: Redux Toolkit / Zustand
- **路由**: React Router v6
- **图表库**: Chart.js / D3.js
- **测试**: Jest + React Testing Library
- **构建工具**: Vite
- **样式**: CSS Modules / Styled Components

### 开发规范

1. **组件设计原则**
   - 单一职责原则
   - 可复用性
   - 可测试性
   - 可访问性

2. **代码规范**
   - ESLint + Prettier
   - TypeScript严格模式
   - 组件文档化
   - 单元测试覆盖率≥80%

3. **性能优化**
   - 组件懒加载
   - 虚拟滚动
   - 数据缓存
   - 图片优化

4. **安全考虑**
   - XSS防护
   - CSRF防护
   - 输入验证
   - 权限检查

### 文件结构

```
src/
├── components/
│   ├── management/
│   │   ├── DataSourceManager/
│   │   ├── UserManager/
│   │   ├── SystemConfig/
│   │   └── Monitoring/
│   ├── common/
│   │   ├── Layout/
│   │   ├── Table/
│   │   ├── Form/
│   │   └── Charts/
│   └── ui/
├── pages/
│   ├── management/
│   │   ├── DataSourceManagement.tsx
│   │   ├── UserManagement.tsx
│   │   ├── SystemConfig.tsx
│   │   └── Monitoring.tsx
│   └── dashboard/
├── services/
│   ├── management/
│   │   ├── dataSourceService.ts
│   │   ├── userService.ts
│   │   ├── configService.ts
│   │   └── monitoringService.ts
│   └── api/
├── hooks/
│   ├── useDataSource.ts
│   ├── useUserManagement.ts
│   ├── useSystemConfig.ts
│   └── useMonitoring.ts
├── utils/
│   ├── permissions.ts
│   ├── validation.ts
│   └── formatters.ts
└── types/
    ├── management.ts
    ├── user.ts
    └── system.ts
```

### API接口设计

**数据源管理API**

```typescript
// GET /api/management/datasources
interface GetDataSourcesResponse {
  data: DataSource[];
  total: number;
  page: number;
  pageSize: number;
}

// POST /api/management/datasources
interface CreateDataSourceRequest {
  name: string;
  type: 'mysql' | 'postgresql' | 'csv' | 'excel';
  config: DataSourceConfig;
}

// PUT /api/management/datasources/:id
interface UpdateDataSourceRequest {
  name?: string;
  config?: DataSourceConfig;
  enabled?: boolean;
}

// DELETE /api/management/datasources/:id
// POST /api/management/datasources/:id/test
```

**用户管理API**

```typescript
// GET /api/management/users
interface GetUsersResponse {
  data: User[];
  total: number;
  page: number;
  pageSize: number;
}

// POST /api/management/users
interface CreateUserRequest {
  username: string;
  email: string;
  password: string;
  role: string;
  permissions?: string[];
}

// PUT /api/management/users/:id
interface UpdateUserRequest {
  username?: string;
  email?: string;
  role?: string;
  permissions?: string[];
  enabled?: boolean;
}

// DELETE /api/management/users/:id
// POST /api/management/users/:id/roles
// DELETE /api/management/users/:id/roles/:roleId
```

**系统配置API**

```typescript
// GET /api/management/config
interface GetSystemConfigResponse {
  general: GeneralConfig;
  security: SecurityConfig;
  performance: PerformanceConfig;
  features: FeatureFlags;
}

// PUT /api/management/config
interface UpdateSystemConfigRequest {
  general?: Partial<GeneralConfig>;
  security?: Partial<SecurityConfig>;
  performance?: Partial<PerformanceConfig>;
}

// GET /api/management/features
// PUT /api/management/features/:feature
```

**监控和日志API**

```typescript
// GET /api/management/monitoring/metrics
interface GetSystemMetricsResponse {
  cpu: number;
  memory: number;
  disk: number;
  network: NetworkMetrics;
  database: DatabaseMetrics;
  api: ApiMetrics;
}

// GET /api/management/monitoring/logs
interface GetLogsRequest {
  level?: 'info' | 'warn' | 'error';
  service?: string;
  startTime?: string;
  endTime?: string;
  page?: number;
  pageSize?: number;
}

// GET /api/management/monitoring/alerts
interface GetAlertsResponse {
  data: Alert[];
  total: number;
  unacknowledged: number;
}
```

### 测试策略

1. **单元测试**
   - 组件渲染测试
   - 用户交互测试
   - 业务逻辑测试
   - 工具函数测试

2. **集成测试**
   - API接口测试
   - 页面流程测试
   - 权限控制测试
   - 数据流测试

3. **端到端测试**
   - 完整用户流程
   - 跨浏览器兼容性
   - 响应式设计测试
   - 性能测试

4. **安全测试**
   - 权限绕过测试
   - 输入验证测试
   - XSS/CSRF测试
   - 敏感数据泄露测试
